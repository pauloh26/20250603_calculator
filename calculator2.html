<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROI Calculator</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
     // initializing supabase (creating client)
    const SUPABASE_URL = "https://pclvnmhebuqxrohbhuxe.supabase.co";
    const SUPABASE_KEY = "sb_publishable_DUqu-lqIItVEHj7EGefIng_74qJN-w5";
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>
  <script src="supa-sesh.js" defer></script>
  <script src="track.js" defer></script>
</head>

<body>
  <h1>ROI Calculator</h1>
  <h3>Hello World!!</h3>
    <p>Calculate your Return on Investment (ROI) easily!</p>

  <input id="name" type="text" placeholder="Your First Name" required />
  <input id="investment" type="number" placeholder="Investment (€)" />
  <input id="ret" type="number" placeholder="Return (€)" />
  <button id="calculateButton">Calculate ROI</button>


  <script>

    // I think this is an anonymous function that listens to click on button,
    // and has another function (CalculateROI) as a parameter, which is defined further below.
    document.getElementById('calculateButton').addEventListener('click', calculateROI);

   // Define a function (async because it calls supabase) to make a calculation,
   // send data to the server, and more
   async function calculateROI() {
     const name = document.getElementById('name').value.trim();
     const investment = parseFloat(document.getElementById('investment').value);
     const ret = parseFloat(document.getElementById('ret').value);

     // If no data entered, show alert message
     if (!name || isNaN(investment) || isNaN(ret)) {
       alert("Please enter your name, investment, and return.");        
       return; };

     // Otherwise, calculate ROI
     const roi = ((ret - investment) / investment) * 100;

     // Define variable (or object?) to be referenced later
     const calcData = {
      name,
      investment,
      ret,
      roi: roi.toFixed(2) };


      // Here goes the block I am swaping to manage the new Vercel setup
      try {
        const res = await fetch('/api/server-logic', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: globalSeshObject.globalSeshUser, name: name, investment: investment, ret: ret, roi: roi })
      });

        // Maybe here I want to display in the console or alert the whole json I get as a response? 
        // I guess in case supabase returns an error, this "data" const below will get that error assigned
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Request failed');
        }

      } catch (err) {
        alert(err.message);
      }



     // Save to browser storage
     localStorage.setItem("lastCalculation", JSON.stringify(calcData));

     // Go to results page
     window.location.href = "result.html";
};
  </script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
     // initializing supabase (creating client)
    const SUPABASE_URL = "https://pclvnmhebuqxrohbhuxe.supabase.co";
    const SUPABASE_KEY = "sb_publishable_DUqu-lqIItVEHj7EGefIng_74qJN-w5";
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>
  <script src="supa-sesh.js" defer></script>
  <script src="track.js" defer></script>
  <style> body { font-family: Arial, sans-serif; margin: 2em; } .card { padding: 1em; border: 1px solid #ccc; margin-bottom: 1em; } </style>
</head>

<body>
  <h1>Admin Dashboard</h1>
  <div class="card" id="totalUsers"></div>
  <div class="card" id="avgPageDuration"></div>
  <div class="card" id="avgCalcsPerUser"></div>
  <div class="card" id="countries"></div>

  <script>
 
    async function loadDashboard() {    

   try {
      // Try to query total profiles
      const { data: proFiles, error: usersError } = await window.supabaseClient.from("profiles").select("id");
            if (usersError) {
                  alert("There was a supabase related error fetching your total users" + usersError ); }
            else if (proFiles) {
                  // Display total users
                  const totalUserss = proFiles.length;
                  document.getElementById("totalUsers").innerText = "Total users: " + totalUserss; }
            else {
                  document.getElementById("totalUsers").innerText = "Total users: no data"; }

      }   
   catch (err) {
        alert("Unexpected error fetching total users." + err);
        }


    
   try {
      // Try to query duration from page_events
      const { data: events, error:eventsError } = await window.supabaseClient.from("page_events").select("duration_seconds");
            if (eventsError) {
                  alert("There was a supabase related error fetching duration from page_events" + eventsError ); }
            else if (Array.isArray(events) && events.length > 0) {
                  // Calculate avg page duration
                  const totalDuration = events.reduce((a,b) => a + b.duration_seconds, 0);
                  const avgDuration = (totalDuration / events.length).toFixed(1);           
                  // Display avg page duration
                  document.getElementById("avgPageDuration").innerText = "Avg time on page: " + avgDuration + "s"; }
            else {
                  document.getElementById("avgPageDuration").innerText = "Avg time on page: no data"; }
        }   
   catch (err) {
        alert("Unexpected error fetching duration from page_events," + err);
        }   



   try {
        // Try to fetch pre-aggregated metrics from the SQL view "dashboard_metrics", it's single row
        const { data: metrics, error: metricsError } = await window.supabaseClient.from('dashboard_metrics').select('*');
            if (metricsError) {
                  alert("There was a supabase related error fetching dashboard_metrics view" + metricsError ); }
            else if (Array.isArray(metrics) && metrics.length > 0) {
                  // Use the first row returned by the view
                  const row = metrics[0];
                  const totalCalculations = Number(row.total_calculations) || 0;
                  const usersWithCalcs = Number(row.users_with_calcs) || 0;
                  // Calculate and display avg calculations per user
                  const avgCalcs = (totalCalculations / Math.max(usersWithCalcs, 1)).toFixed(2);
                  document.getElementById("avgCalcsPerUser").innerText = "Avg calcs per user: " + avgCalcs; }
            else {
                  document.getElementById("avgCalcsPerUser").innerText = "Avg calcs per user: no data"; }
            }      
    catch (err) {
                alert("Unexpected error fetching dashboard_metrics view" + err);
       }       



      // Countries (placeholder)
      document.getElementById("countries").innerText = "Countries: data collection WIP";
    }

    loadDashboard();
  </script>
</body>
</html>
